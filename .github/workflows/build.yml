name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Compile PyInstaller Bootloader (Anti-Virus Evasion)
      run: |
        # Install build tools
        pip install wheel
        
        # Clone PyInstaller source
        git clone https://github.com/pyinstaller/pyinstaller.git
        cd pyinstaller
        
        # Modify bootloader source to change signature (Evade Heuristics)
        $file = "bootloader/src/pyi_launch.c"
        if (Test-Path $file) {
            (Get-Content $file) -replace 'Error loading Python DLL', 'Error loading App DLL' | Set-Content $file
        }
        
        # Compile the bootloader
        cd bootloader
        python ./waf all
        cd ..
        
        # Install this custom-compiled version
        pip install .

    - name: Build with PyInstaller
      run: |
        pyinstaller src/eisquads/__main__.py `
          --paths src/eisquads `
          --name eis-quads `
          --onedir `
          --windowed `
          --clean `
          --noconfirm `
          --noupx `
          --icon=eisquads.ico `
          --version-file src/version_info.txt `
          --hidden-import pkgutil `
          --exclude-module PyQt6.QtQml `
          --exclude-module PyQt6.QtQuick `
          --exclude-module PyQt6.QtSql `
          --exclude-module PyQt6.QtNetwork `
          --exclude-module PyQt6.QtWebEngine `
          --exclude-module PyQt6.QtWebEngineCore `
          --exclude-module PyQt6.QtWebEngineWidgets `
          --exclude-module PyQt6.QtMultimedia `
          --exclude-module PyQt6.QtBluetooth `
          --exclude-module PyQt6.QtNfc `
          --exclude-module PyQt6.QtPositioning `
          --exclude-module PyQt6.QtSensors `
          --exclude-module PyQt6.QtSerialPort `
          --exclude-module PyQt6.QtWebSockets `
          --exclude-module PyQt6.Qt3DCore `
          --exclude-module PyQt6.Qt3DInput `
          --exclude-module PyQt6.Qt3DLogic `
          --exclude-module PyQt6.Qt3DRender `
          --exclude-module PyQt6.QtCharts `
          --exclude-module PyQt6.QtDataVisualization `
          --exclude-module PyQt6.QtRemoteObjects `
          --exclude-module PyQt6.QtScxml `
          --exclude-module PyQt6.QtSvg `
          --exclude-module PyQt6.QtSvgWidgets `
          --exclude-module PyQt6.QtTest `
          --exclude-module PyQt6.QtTextToSpeech `
          --exclude-module PyQt6.QtXml `
          --exclude-module tkinter

    - name: Zip the Build
      run: |
        Compress-Archive -Path dist/eis-quads -DestinationPath eis-quads.zip

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: eis-quads.zip
